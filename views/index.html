<!DOCTYPE html>
<html>
  <head>
    <title>Message Board</title>
      <link rel='stylesheet' href='/stylesheets/bootstrap.css' />
      <script src="/javascripts/jquery-1.9.1.js"></script>
      <script src="/javascripts/bootstrap.js"></script>
      <script src="/javascripts/bootbox.min.js"></script>
  </head>
  <body>
    <div class="row">
        <div class="col-md-4 col-md-offset-4">
           <h1> Message Board</h1>
        </div>
    </div>
    <div class="row col-md-12 col-md-offset-1">
        <form id="commentForm" class="form-inline" role="form">
            <div class="form-group col-md-2">
                <input type="text" class="form-control" id="name" placeholder="请填写姓名或者邮箱...">
            </div>
            <div class="form-group col-md-6 ">
                <input type="text" class="form-control" id="comment" placeholder="请输入评论内容...">
            </div>
            <button type="submit" class="btn btn-primary">submit</button>
        </form>
    </div>
    <p>
       <div class="row col-md-8 col-md-offset-1">
            <ul class="list-group">
                {%for item in items %}
                <li class="list-group-item">
                    <span class="reply pull-right">
                        <button type="button" class="btn btn-info">reply</button>
                    </span>
                    <ul class="comment-group list-unstyled">
                        <input type="hidden" value="{{item.comment.id}}"/>
                        <p>
                            <li>{{item.comment.content}}</li>
                            <li>{{item.comment.createTime|date("Y-n-d H:i") }}&nbsp<a href="#">@{{item.comment.username}}</a></li>
                        <p>
                        {% if item.replys.length %}
                        <li>
                            <ol class="reply-group">
                                {%for reply in item.replys %}
                                <p>
                                    <li>{{reply.content}}</li>
                                    {{reply.createTime|date("Y-n-d H:i") }}&nbsp<a href="#">@{{reply.username}}</a>
                                </p>
                                {% endfor %}
                            </ol>
                        </li>
                        {% endif %}

                     </ul>
                </li>
                {% endfor %}
            </ul>
        </div>
    </p>
  </body>
  <script type="text/javascript">
      function checkNull (id_selector){
          if($(id_selector).val() == ""){
              bootbox.dialog({
                  message: '写点东西吧，内容不能为空哦。',
                  title: "提示",
                  backdrop:false,
                  buttons: {
                      main: {
                          label: "OK!",
                          className: "btn-primary"
                      }
                  }
              });
              return false;
          }
          return true;
      };
      $( ".btn.btn-primary" ).click(function( ) {
          if(!checkNull("#comment")){
              return false;
          }
          $.ajax({
              type: "POST",
              url: '/comment/create',
              data: {
                  "name" :$("#name").val(),
                  "comment":$("#comment").val()
              }, // serializes the form's elements.
              success: function(data)
              {
                  $("ul.list-group li:eq(0)").before(
                      '<li class="list-group-item">' +
                      '<span class="reply pull-right">' +
                      '<button type="button" class="btn btn-info">reply</button>' +
                      '</span>' +
                      '<ul class="list-unstyled">' +
                      '<li>'+data["content"] +'</li>' +
                      '<li>'+data["createTime"]+'&nbsp'+'<a href="#">@'+data["username"]+'</a></li>' +
                      '</ul>' +
                      '</li>'
                  );
                  if(data["isSuccess"]){
                      $("#name").val("");
                      $("#comment").val("");
                      bootbox.dialog({
                          message: '发表评论成功。',
                          title: "提示",
                          backdrop:false,
                          buttons: {
                              main: {
                                  label: "OK!",
                                  className: "btn-primary"
                              }
                          }
                      });
                  }else{
                      bootbox.dialog({
                          message: '发表评论失败，好像有什么东西混进来了。',
                          title: "提示",
                          backdrop:false,
                          buttons: {
                              main: {
                                  label: "OK!",
                                  className: "btn-primary"
                              }
                          }
                      });
                  }
              }
          });
          return false;
      });
      $(".list-group").on("click", '.btn.btn-info', function(){
          $current_ul = $(this).parent().parent("li").children("ul");
          if($current_ul.children().has("form").length <= 0){
              $current_ul.append('<li>'+
                      '<div class="row col-md-12">'+
                      '<form class="form-inline" role="form">'+
                      '<div class="form-group col-md-2">'+
                      '<input type="text" class="form-control" id="r_name" placeholder="请填写姓名或者邮箱...">'+
                      '</div>'+
                      '<div class="form-group col-md-9 ">'+
                      '<input type="text" class="form-control" id="r_comment" placeholder="请输入回复内容...">'+
                      '</div>'+
                      '<button type="submit" class="btn btn-default">reply</button>'+
                      '</form>'+
                      '</div>'+
                      '</li>');
          };
          return false;
      });


      $(".list-group").on("click", '.btn.btn-default', function(){
          $current_ul = $(this).closest("ul");
          var cid = $current_ul.children("input[type='hidden']").val();
          alert($current_ul.children().html());
          if(!checkNull("#r_comment")){
              return false;
          }
          $.ajax({
              type: "POST",
              url: '/reply/createss',
              data: {
                  "name" :$("#r_name").val(),
                  "comment":$("#r_comment").val(),
                  "cid" : cid
              },
              success: function(data)
              {
                  if(data["isSuccess"]){
                      $("#r_name").val("");
                      $("#r_comment").val("");
                      bootbox.dialog({
                          message: '回复成功。',
                          title: "提示",
                          backdrop:false,
                          buttons: {
                              main: {
                                  label: "OK!",
                                  className: "btn-primary"
                              }
                          }
                      });
                  }else{
                      bootbox.dialog({
                          message: '回复失败，好像有什么东西混进来了。',
                          title: "提示",
                          backdrop:false,
                          buttons: {
                              main: {
                                  label: "OK!",
                                  className: "btn-primary"
                              }
                          }
                      });
                  }
              }
          });
          return false;
      });
  </script>
</html>